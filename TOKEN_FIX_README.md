# حل مشكلة التوكين في إعادة تعيين كلمة المرور

## المشكلة
كان التوكين الذي يرسله الباك إند يحتوي على رموز خاصة مثل `+`, `/`, `=` التي تحتاج إلى معالجة خاصة عند إرسالها عبر URL.

## الحل المطبق

### 1. إنشاء ملف TokenUtils
تم إنشاء ملف `src/app/shared/utils/token-utils.ts` يحتوي على دوال مساعدة لمعالجة التوكين:

- `cleanAndDecodeToken()`: تنظيف وفك ترميز التوكين المستلم من URL
- `processTokenForBackend()`: معالجة التوكين للباك إند
- `isValidToken()`: التحقق من صحة التوكين
- `logTokenInfo()`: طباعة معلومات التوكين للتشخيص

### 2. تحديث الكومبوننتس
تم تحديث الكومبوننتس التالية:
- `reset-password.component.ts`
- `restpassword.component.ts`
- `auth.service.ts`

### 3. التحسينات المضافة
- معالجة أفضل للتوكين
- رسائل خطأ مفصلة
- سجلات تشخيص مفصلة
- التحقق من صحة التوكين قبل الإرسال

## كيفية الاختبار

### 1. تشغيل التطبيق
```bash
npm start
```

### 2. اختبار إعادة تعيين كلمة المرور
1. اذهب إلى صفحة "نسيت كلمة المرور"
2. أدخل إيميل صحيح
3. اضغط "إرسال"
4. انتظر الإيميل
5. انقر على الرابط في الإيميل
6. أدخل كلمة مرور جديدة
7. اضغط "إعادة تعيين كلمة المرور"

### 3. مراجعة السجلات
افتح Developer Tools (F12) واذهب إلى Console لمراجعة:
- معلومات التوكين المستلم
- عملية تنظيف التوكين
- البيانات المرسلة للباك إند
- أي أخطاء تحدث

### 4. السجلات المتوقعة
```
Reset Password - Query Params: {userId: "...", code: "..."}
Reset Password - Original Code Info: {length: 123, preview: "...", ...}
Reset Password - Cleaned Code Info: {length: 123, preview: "...", ...}
AuthService - Original Token Info: {length: 123, preview: "...", ...}
AuthService - Processed Token Info: {length: 123, preview: "...", ...}
Sending reset password request: {userId: "...", codeLength: 123, passwordLength: 8}
```

## إذا استمرت المشكلة

### 1. تحقق من الباك إند
تأكد من أن الباك إند يستخدم:
```csharp
var encodedToken = WebUtility.UrlEncode(token);
var decodedToken = WebUtility.UrlDecode(dto.Code);
```

### 2. شارك المعلومات
إذا استمرت المشكلة، شارك:
- سجلات Console من المتصفح
- رسالة الخطأ الدقيقة
- شكل التوكين في الرابط (أول 50 حرف)

### 3. اختبار بديل
يمكنك اختبار التوكين يدوياً:
1. انسخ التوكين من الرابط
2. الصقه في Console
3. جرب `decodeURIComponent(token)`
4. تحقق من النتيجة

## ملاحظات مهمة
- التوكين يجب أن يكون طويلاً (أكثر من 10 أحرف)
- التوكين قد يحتوي على رموز خاصة مثل `+`, `/`, `=`
- يجب معالجة التوكين بشكل صحيح قبل إرساله للباك إند 